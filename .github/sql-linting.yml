name: SQL Syntax Check and Lint

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  check-and-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Install sql-lint
        run: npm install -g sql-lint

      - name: Syntax Check with PostgreSQL
        run: |
          for file in $(find . -name "*.sql"); do
            echo "Checking syntax for $file"
            psql -v ON_ERROR_STOP=1 -f "$file" -U postgres -d postgres --echo-queries -h localhost
          done
        env:
          PGPASSWORD: 1234

      - name: Lint SQL files
        run: |
          for file in $(find . -name "*.sql"); do
            echo "Linting $file"
            sql-lint "$file"
          done
